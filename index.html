
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Prabhav Baba Astrology Chat</title>
  <style>
    /* WhatsApp style dark theme chat */
    body {
      margin: 0; padding: 0;
      background: #121212; color: #eee;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      height: 100vh; display: flex; flex-direction: column;
    }
    #header {
      background: #075e54;
      color: white;
      padding: 12px 15px;
      font-weight: bold;
      font-size: 1.3rem;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 2px 4px #000a;
    }
    #header img {
      width: 40px; height: 40px;
      border-radius: 50%;
      border: 2px solid #25d366;
    }
    #header .status {
      font-size: 0.9rem;
      color: #b2d8b2;
    }
    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      background: #121212;
    }
    .message {
      max-width: 75%;
      padding: 10px 14px;
      margin: 8px 0;
      border-radius: 20px;
      line-height: 1.3;
      word-wrap: break-word;
      box-shadow: 0 1px 2px #0009;
      font-size: 1rem;
    }
    .bot {
      background: #262d31;
      color: #d4d4d4;
      border-bottom-left-radius: 0;
      align-self: flex-start;
      animation: fadeIn 0.4s ease;
      position: relative;
    }
    .user {
      background: #25d366;
      color: black;
      border-bottom-right-radius: 0;
      align-self: flex-end;
      animation: fadeIn 0.4s ease;
      position: relative;
      display: block;
    }
    #inputContainer {
      display: flex;
      background: #202c33;
      padding: 10px 15px;
      align-items: center;
      gap: 10px;
    }
    #userInput {
      flex: 1;
      background: #323c41;
      border: none;
      border-radius: 20px;
      padding: 12px 20px;
      font-size: 1rem;
      color: #eee;
      outline: none;
    }
    #sendBtn {
      background: #128c7e;
      border: none;
      color: white;
      padding: 10px 18px;
      border-radius: 20px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    #sendBtn:hover:not(:disabled) {
      background: #0b6a60;
    }
    #sendBtn:disabled {
      background: #666;
      cursor: not-allowed;
    }
    #typingIndicator {
      font-style: italic;
      color: #bbb;
      margin-left: 15px;
      font-size: 0.9rem;
      display: none;
      user-select: none;
    }
    @keyframes fadeIn {
      from {opacity: 0; transform: translateY(10px);}
      to {opacity: 1; transform: translateY(0);}
    }
    /* Scrollbar for chat */
    #chat::-webkit-scrollbar {
      width: 6px;
    }
    #chat::-webkit-scrollbar-thumb {
      background: #555;
      border-radius: 3px;
    }
  </style>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>

  <div id="header">
    <img src="https://i.pravatar.cc/150?img=5" alt="Prabhav Baba" />
    Prabhav Baba <span class="status">â€¢ Online</span>
  </div>

  <div id="chat"></div>

  <div id="inputContainer">
    <input type="text" id="userInput" autocomplete="off" placeholder="Type your message in Hinglish..." />
    <button id="sendBtn" disabled>Send</button>
    <span id="typingIndicator">Prabhav Baba typing...</span>
  </div>

  <script>
    // Firebase config - replace with your values from Firebase Console
    const firebaseConfig = {
      apiKey: "YOUR_FIREBASE_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const chatDiv = document.getElementById('chat');
    const input = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const typingIndicator = document.getElementById('typingIndicator');

    let step = 0;
    let userData = {};
    let isTyping = false;

    // Enable send button only if input has text
    input.addEventListener('input', () => {
      sendBtn.disabled = input.value.trim().length === 0 || isTyping;
    });

    // Add message bubble to chat and scroll
    function addMessage(text, role) {
      const msgDiv = document.createElement('div');
      msgDiv.className = `message ${role}`;
      msgDiv.textContent = text;
      chatDiv.appendChild(msgDiv);
      chatDiv.scrollTop = chatDiv.scrollHeight;
      saveMessageToFirebase(role, text);
    }

    // Save message to Firebase Realtime DB under chats/{username}_{timestamp}
    function saveMessageToFirebase(sender, text) {
      if (!userData.name) return; // wait till name is entered
      const chatKey = userData.name + '_' + Date.now();
      db.ref('chats/' + chatKey).set({
        sender,
        text,
        timestamp: Date.now()
      });
    }

    // Helper delay
    function delay(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    // Sample time-based message
    function timeOfDayMessage() {
      const hour = new Date().getHours();
      if (hour < 12) return "Subah ka samay aapke liye shubh hai, aaj nayi shuruaat hogi.";
      else if (hour < 17) return "Dopahar ka samay thoda savdhaan rehne ka hai, lekin fayda bhi hoga.";
      else return "Shaam ka samay aapke liye thoda sukoon bhara hai.";
    }

    // Random generic astrology style messages
    function randomBarnum() {
      const msgs = [
        "Aapka man kabhi kabhi chinta mein rehta hai, par aapka dil bahut bada hai.",
        "Kuch log aapki achhaiyon ko nahi samajh pate, par yeh aapko majboot banata hai.",
        "Aapka rujhan nayi cheezein seekhne mein zyada hai aajkal.",
        "Sambhav hai aapke rishte mein kuch badlav aaye.",
        "Aaj kuch naya mauka aapke raste mein aa sakta hai."
      ];
      return msgs[Math.floor(Math.random() * msgs.length)];
    }

    // Call Firebase Cloud Function that calls OpenAI API
    async function getAstrologyReply(userInput, userData) {
      isTyping = true;
      typingIndicator.style.display = 'inline';
      sendBtn.disabled = true;

      try {
        const response = await fetch('https://YOUR_REGION-YOUR_PROJECT.cloudfunctions.net/chatWithAstrologer', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userInput, userData })
        });

        if (!response.ok) throw new Error('Backend error');

        const data = await response.json();
        return data.reply;
      } catch (err) {
        console.error(err);
        return "Sorry, kuch problem ho gayi. Thodi der me try karo.";
      } finally {
        isTyping = false;
        typingIndicator.style.display = 'none';
        sendBtn.disabled = input.value.trim().length === 0;
      }
    }

    // Main function to handle user messages & bot replies stepwise
    async function processBotReply(userText) {
      if (step < 5) {
        // Collect basic info stepwise
        switch(step) {
          case 0:
            addMessage('Namaste! Aapka naam kya hai?', 'bot');
            step++;
            break;
          case 1:
            userData.name = userText;
            addMessage(userText, 'user');
            addMessage(`Shukriya, ${userData.name}. Aapka janam din kab hai? (DD-MM-YYYY)`, 'bot');
            step++;
            break;
          case 2:
            if (!/^\d{2}-\d{2}-\d{4}$/.test(userText.trim())) {
              addMessage(userText, 'user');
              addMessage("Date format sahi nahi hai, please DD-MM-YYYY format me likho.", 'bot');
              break;
            }
            userData.dob = userText.trim();
            addMessage(userText, 'user');
            addMessage('Janam samay kya hai? (24-hour format, e.g. 14:30)', 'bot');
            step++;
            break;
          case 3:
            if (!/^\d{1,2}:\d{2}$/.test(userText.trim())) {
              addMessage(userText, 'user');
              addMessage("Samay sahi nahi likha, 24-hour format me batao, jaise 06:15 ya 18:45.", 'bot');
              break;
            }
            userData.tob = userText.trim();
            addMessage(userText, 'user');
            addMessage('Aapka janm sthal (city) kya hai?', 'bot');
            step++;
            break;
          case 4:
            userData.birthPlace = userText;
            addMessage(userText, 'user');
            addMessage('Theek hai! Thoda ruk jao, aapke kundli ke hisaab se kuch baatein batata hoon...', 'bot');
            await delay(1500);
            addMessage(timeOfDayMessage(), 'bot');
            await delay(1500);
            addMessage(randomBarnum(), 'bot');
            await delay(1500);
            addMessage('Aapka man kiya toh apna sawal pooch sakte hain, ya koi haan/no waale button dabakar jawab de sakte hain.', 'bot');
            step++;
            break;
        }
      } else {
        addMessage(userText, 'user');
        const botReply = await getAstrologyReply(userText, userData);
        addMessage(botReply, 'bot');
      }
    }

    // Send button click and Enter key handler
    sendBtn.addEventListener('click', () => {
      if (isTyping) return;
      const text = input.value.trim();
      if (!text) return;
      input.value = '';
      sendBtn.disabled = true;
      processBotReply(text);
    });

    input.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !sendBtn.disabled) {
        e.preventDefault();
        sendBtn.click();
      }
    });

    // Start the chat
    window.onload = () => {
      processBotReply('');
      input.focus();
    };
  </script>
</body>
</html>
